function getCurrentAuction(update){jQuery.ajax({dataType:"json",url:end_points.auction}).done(function(data){if(data){for(var i=0;i<data.length;i++)!data[i].auction.price||"inprogress"!==data[i].auction.status&&"complete"!==data[i].auction.status?data[i].data.price=data[i].data.price.toFixed(2):data[i].data.price=data[i].auction.price.toFixed(2);1==update&&Push.create("Price Update",{body:"The price for "+data[0].data.name.trim()+" is now £"+data[0].data.price,icon:data[0].data.images[0].url,timeout:14e3,onClick:function(){window.location.href.indexOf("todays-products")==-1&&(window.location.href="/todays-products"),this.close()}}),window.location.href.indexOf("todays-products")>1?buildTodaysProductsAuction(data):(data[0]&&(jQuery("#triangle").addClass("active-product"),jQuery("#triangle-outter").addClass("active-product"),jQuery("#product_0").addClass("active-product"),jQuery("#productImg_0").attr("src",data[0].data.images[0].url),jQuery("#productName_0").html('<a href="/p/'+data[0].data.productcode+'">'+data[0].data.name.trim()+"</a>"),jQuery("#productPrice_0").html("<strong>&pound;"+numberWithCommas(data[0].data.price)+"</strong>")),data[1]?(jQuery("#product_1").addClass("part-sell"),jQuery("#productImg_1").attr("src",data[1].data.images[1].url),jQuery("#productName_1").html('<a href="/p/'+data[1].data.productcode+'">'+data[1].data.name.trim()+"</a>"),jQuery("#productPrice_1").html("<strong>&pound;"+numberWithCommas(data[1].data.price)+"</strong>")):jQuery("#product_1").removeClass("part-sell")),getRecentAuctions()}})}function getRecentAuctions(){jQuery.ajax({dataType:"json",url:end_points.todaysproducts}).done(function(data){if(data){for(var i=0;i<data.length;i++)!data[i].auction.price||"inprogress"!==data[i].auction.status&&"complete"!==data[i].auction.status?data[i].data.price=data[i].data.price.toFixed(2):data[i].data.price=data[i].auction.price.toFixed(2);if(window.location.href.indexOf("todays-products")>1)buildTodaysProducts(data);else{var i,j;for(i=1,j=0;i<4;i++,j++)jQuery("#product_"+i).hasClass("part-sell")!==!0?"undefined"!=typeof data[j]&&(jQuery("#productImg_"+i).attr("src",data[j].data.images[0].url?data[j].data.images[0].url:data[j].data.imageUrl),jQuery("#productName_"+i).html('<a href="/p/'+data[j].data.productcode+'">'+data[j].data.name.trim()+"</a>"),jQuery("#productPrice_"+i).html("<strong>&pound;"+numberWithCommas(data[j].data.price)+"</strong>")):j--}}})}function buildTodaysProductsAuction(data){for(var html="",i=0;i<data.length;i++)html+='<div  class="column large-12 small-9 row">',html+="<p>"+data[i].data.name.trim()+"</p>",html+="<p>"+data[i].data.productcode+"</p>",html+='<img class="large-6" src="'+data[i].data.images[0].url+'"/>',html+='<span id="auctionPrice">&pound;'+numberWithCommas(data[i].data.price)+"</span>",html+="<p>"+data[i].data.description+"</p>",html+='<button style="background: #00B109" data-toggle="example-dropdown2" type="button" class="button" class="add-basket" aria-controls="example-dropdown2" data-is-focus="false" data-yeti-box="example-dropdown2" aria-haspopup="true" aria-expanded="false">Add to basket</button>',html+="</div>";jQuery("#current-product").html(html)}function buildTodaysProducts(data){for(var html="",i=0;i<data.length;i++)html+='<article id="'+data[i].data.productcode+'" class="columns large-3 small-4 text-center '+(i+1===data.length?"end":"")+'">',html+='<a href="/p/'+data[i].data.productcode+'">',html+="<div>",html+='<img src="'+data[i].data.images[0].url+'"/>',html+="<p>"+data[i].data.name+"</p>",html+="<p>"+data[i].data.price+"</p>",html+="</div>",html+="</a>",html+="</article>";jQuery("#dvDayShowProducts").html(html)}function numberWithCommas(x){return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}function toggleFacets(e){console.log(e)}function updateBasket(title,price,image,productCode){jQuery(".my-basket-prdocut-name").text(title),jQuery(".my-basket-price").text("£"+price),jQuery(".my-basket-image").attr("src",image),jQuery(".header-container .sp-box").fadeIn();var theBasketItem=null;if(jQuery("#basket-item-"+productCode).length>0){var quantity=jQuery(".quantity",jQuery("#basket-item-"+productCode)).val();quantity+=1;var sub_total=quantity*price;jQuery(".basket-product-total",jQuery("#basket-item-"+productCode)).text("£"+sub_total),jQuery(".basket-product-total",jQuery("#basket-item-"+productCode)).attr("data-sub-total",sub_total),theBasketItem=jQuery("#basket-item-"+productCode)}else{var item=jQuery("#basket-item").clone();jQuery(item).show(),jQuery(item).attr("id","basket-item-"+productCode),jQuery(".basket-product-image",item).attr("src",image),jQuery(".basket-product-title",item).text(title),jQuery(".basket-product-price",item).text("£"+price),jQuery(".basket-product-price",item).attr("data-product-price",price),jQuery(".basket-product-total",item).text("£"+1*price),jQuery(".basket-product-total",item).attr("data-sub-total",1*price),theBasketItem=item}return jQuery(item).appendTo(".basket-data"),jQuery("#basket-count").fadeIn().text(jQuery(".basket-item").length-1),setTimeout(function(){jQuery(".header-container .sp-box").fadeOut()},4e3),theBasketItem}function basketTotalUpdate(){var total=0;jQuery(".basket-item").each(function(index){if(index>0){var productPrice=jQuery(".basket-product-price",this).attr("data-product-price"),quantity=parseInt(jQuery(".quantity",this).val()),subtotal=productPrice*quantity;total+=subtotal,jQuery(".basket-product-total",this).attr("data-sub-total",subtotal),jQuery(".basket-product-total",this).text("£"+subtotal.toFixed(2))}}),jQuery(".basket-item").length-1<=0?jQuery("#basket-count").fadeOut():jQuery("#basket-count").fadeIn().text(jQuery(".basket-item").length-1),jQuery("#basket-total").text("£"+total.toFixed(2))}jQuery(document).foundation();var ibizaHubProxy=function(){return getCurrentAuction(),console.log(jQuery.connection.crystalHubProxy),{ibizaHubProxy:jQuery.connection.ibizaHubProxy,startServer:function(){var self=this;self.ibizaHubProxy.connection.url=end_points.signalr,self.ibizaHubProxy.connection.start()},clientEventsListerners:function(){this.ibizaHubProxy.client.auctionUpdate=function(){getCurrentAuction(1)},this.ibizaHubProxy.client.todaysProductsRefresh=function(){getCurrentAuction(1)},this.ibizaHubProxy.client.auctionRefresh=function(){getCurrentAuction(1)}},init:function(){this.startServer(),this.clientEventsListerners()}}}();jQuery(document).ready(function(){jQuery(".menu_banner img").attr("src").length>0&&jQuery(".ibiza-menu  > .menus").first().after('<ul style="width: 100%; height: 57px; background: rgb(255, 0, 0) none repeat scroll 0% 0% ! important;"><img src="'+jQuery(".menu_banner img").attr("src")+'" alt="Promotional Sewing Quarter Banner" /></ul>'),jQuery(document).on("click","#my-basket .close_button",function(){jQuery(".header-container .sp-box").fadeOut()}),jQuery(document).on("click","#basket-con .add_quantity",function(){var container=jQuery(this).parent().parent(),quantity=parseInt(jQuery(".quantity",container).val())+1,basket_id=container.parent().parent().attr("data-basket-product-basketid"),url=basket_update_url.replace("{basketId}",basket_id).replace("{quantity}",quantity);jQuery.ajax({dataType:"json",url:url,method:"POST"}).done(function(){basketTotalUpdate()}),jQuery(".quantity",container).val(quantity)}),jQuery(document).on("click","#basket-con .remove_quantity",function(){var container=jQuery(this).parent().parent();if(!(parseInt(jQuery(".quantity",container).val())<=1)){var quantity=parseInt(jQuery(".quantity",container).val())-1,basket_id=container.parent().parent().attr("data-basket-product-basketid"),url=basket_update_url.replace("{basketId}",basket_id).replace("{quantity}",quantity);jQuery.ajax({dataType:"json",url:url,method:"POST"}).done(function(){basketTotalUpdate()}),jQuery(".quantity",container).val(quantity)}}),jQuery(document).on("click",".basket-remove-item",function(){var container=jQuery(this).parent().parent().parent();console.log(container);var quantity=0,basket_id=container.attr("data-basket-product-basketid"),url=basket_update_url.replace("{basketId}",basket_id).replace("{quantity}",quantity);jQuery.ajax({dataType:"json",url:url,method:"POST"}).done(function(){jQuery(container).fadeOut(),jQuery(container).remove(),basketTotalUpdate()}),jQuery(".quantity",container).val(quantity)});var grid_arr=new Array,grid_ops={itemSelector:"#lev-0 > .menu-item-has-children",columnWidth:320};if(jQuery(".hc2").mouseover(function(){jQuery(".sp-box").is(":visible")||(jQuery("#tri",".hc2").remove(),jQuery("#tri").css({"z-index":"1"}),jQuery("span",this).first().append('<div id="tri"></div>'),jQuery("#basket-con",this).show(),jQuery(".basket-link",this).addClass("active"),jQuery(".basket-link",this).hasClass("active")&&jQuery(".main-nav__backdrop").css({opacity:1,visibility:"visible"}))}).mouseleave(function(){jQuery(".main-nav__backdrop").css({opacity:0,visibility:"hidden"}),jQuery(".basket-link",this).removeClass("active"),jQuery("#tri",".hc2").remove(),jQuery("#basket-con",this).hide()}),jQuery("#tri").mouseleave(function(){jQuery(".search-container").is(":visible")||(jQuery(".search-link",this).removeClass("active"),jQuery("#tri").remove())}),jQuery("#top-bar-menu").mouseleave(function(){jQuery("#tri","#top-bar-menu").remove(),jQuery(".main-nav__backdrop").css({visibility:"hidden",opacity:0})}),jQuery("#menu-main-1  > .menu-item:hover").length>0){var hoverEl=jQuery("#menu-main-1  > .menu-item:hover");if(jQuery("#tri","#top-bar-menu").remove(),jQuery("a",hoverEl).first().append('<div id="tri"></div>'),jQuery("#tri").css({"z-index":"1"}),jQuery(" > .ibiza-menu ul",hoverEl).length>0){jQuery(".main-nav__backdrop").css({opacity:1,visibility:"visible"});var index=jQuery("li",hoverEl).index("#menu-main-1 li");if(jQuery(".menus",hoverEl).hasClass("masonry"))grid_arr[index].masonry("destroy"),grid_arr[index]=jQuery(".menus",hoverEl).masonry(grid_ops);else{var $grid=jQuery(".menus",hoverEl).masonry(grid_ops);grid_arr[index]=$grid,jQuery(".menus",hoverEl).addClass("masonry")}}else jQuery(".ibiza-menu",hoverEl).remove()}jQuery("#menu-main-1 > .menu-item").mouseover(function(){if(jQuery("#tri","#top-bar-menu").remove(),jQuery("a",this).first().append('<div id="tri"></div>'),jQuery(".main-nav__backdrop").css({opacity:1,visibility:"visible"}),jQuery(" > .ibiza-menu ul",this).length>0){if(jQuery(this).hasClass("menu-item-32")){var index=jQuery("li",this).index("#menu-main-1 li");if(jQuery(".menus",this).hasClass("masonry"))grid_arr[index].masonry("destroy"),grid_arr[index]=jQuery(".menus",this).masonry(grid_ops);else{var $grid=jQuery(".menus",this).masonry(grid_ops);grid_arr[index]=$grid,jQuery(".menus",this).addClass("masonry")}}}else jQuery(".ibiza-menu",this).remove()}),jQuery(".main-nav__backdrop").mouseenter(function(){jQuery("#tri","#top-bar-menu").remove(),jQuery(".main-nav__backdrop").css({visibility:"hidden",opacity:0})});var basketItem=jQuery("#basket-item").clone(),basketTotalOut=0;if(jQuery.ajax({url:basket_url,context:document.body}).done(function(data){jQuery("#basket-item").hide();var count=0;jQuery.each(data,function(index,value){count++,console.log(value);var basketTotal=value.price*value.quantity;basketTotalOut+=basketTotal,jQuery("#basket-count").text(count),jQuery("#basket-count").fadeIn();var item=jQuery(basketItem).clone();jQuery(item).attr("id","basket-item-"+value.productCode),jQuery(".basket-product-image",item).attr("src",value.imageURL),jQuery(".basket-product-title",item).text(value.description),jQuery(item).attr("data-basket-product-basketid",value.basketid),jQuery(".basket-product-price",item).text("£"+value.price.toFixed(2)),jQuery(".basket-product-price",item).attr("data-product-price",value.price.toFixed(2)),jQuery(".basket-product-total",item).text("£"+basketTotal.toFixed(2)),jQuery(".basket-product-total",item).attr("data-sub-total",basketTotal.toFixed(2)),jQuery(".quantity",item).val(value.quantity),jQuery(item).appendTo(".basket-data")}),jQuery("#basket-total").text("£"+basketTotalOut.toFixed(2))}),jQuery(document).on("click","#add-basket,.add-basket",function(){if(jQuery(".lvl2").length>0&&jQuery(".lvl2.current").length<=0)return e.preventDefault(),alert("Please select "+jQuery(".lvl2_text").text()+" to continue.");var quantity=jQuery("#middle-label").val(),productCode=jQuery(this).attr("data-product-code"),productDetailID=jQuery(this).attr("data-product-id"),productName=jQuery(this).attr("data-product-name"),productPrice=jQuery(this).attr("data-product-pice"),productImage=jQuery(this).attr("data-product-image"),basket=updateBasket(productName,productPrice,productImage,productCode);jQuery.ajax({dataType:"json",url:"/proxy.php?auctionID=-1&productCode="+productCode+"&productDetailID="+productDetailID+"&quantity="+quantity}).done(function(data){jQuery(basket).attr("data-basket-product-basketid",data)})}),$window=jQuery(window),$window.scroll(function(){$scroll_position=$window.scrollTop(),$scroll_position>80?(jQuery(".header-outter").addClass("sticky"),jQuery(".ibiza-menu").css("margin-top","0px"),jQuery("#basket-con,.main-nav__backdrop").addClass("add-basket-margin"),header_height=jQuery(".header-outter").innerHeight(),jQuery(".header-outter").css("top",0),jQuery("#back_to_top").css("opacity","0.5")):(jQuery(".ibiza-menu").css("margin-top","0"),jQuery("#basket-con,.main-nav__backdrop").removeClass("add-basket-margin"),jQuery("body").css("padding-top","0"),jQuery(".header-outter").removeClass("sticky"),jQuery("#back_to_top").css("opacity",0)),jQuery(window).scrollTop()+jQuery(window).height()<jQuery(document).height()-jQuery(".footer").height()-60?jQuery("#back_to_top").css("position","fixed"):jQuery("#back_to_top").css("position","fixed")}),jQuery("#back_to_top").click(function(event){return event.preventDefault(),jQuery("html, body").animate({scrollTop:0},750),!1}),jQuery(".accordion p:empty, .orbit p:empty").remove(),!window.isAuctionPage){new Swiper(".swiper-container",{loop:!0})}jQuery(".archive-grid .columns").last().addClass("end"),jQuery('iframe[src*="youtube.com"], iframe[src*="vimeo.com"]').each(function(){jQuery(this).innerWidth()/jQuery(this).innerHeight()>1.5?jQuery(this).wrap("<div class='widescreen flex-video'/>"):jQuery(this).wrap("<div class='flex-video'/>")});var sliding=0;jQuery(".search-link").click(function(){jQuery("html, body").animate({scrollTop:0},"slow"),1!=sliding&&(sliding=1,jQuery(".search-container").slideToggle(function(){sliding=0,jQuery(".tt-input").focus()}),jQuery(this).toggleClass("active"),jQuery(this).hasClass("active")?jQuery("span",this).first().append('<div id="tri"></div>'):jQuery("#tri",".hc1").remove())});var url_products=end_points.product_elastic+"_search?from=0&size=5&source=%QUERY",url_howto=end_points.howto_elastic+"_search?from=0&size=5&source=%QUERY",url_categories="/?cat_search=*%QUERY*";jQuery("#search-cancel").click(function(){jQuery(".search-link").first().click(),jQuery("#tri",".header-container").hide().remove()});var cats_engine=new Bloodhound({datumTokenizer:function(hits){return Bloodhound.tokenizers.whitespace(hits.hits)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:url_categories,filter:function(response){return response.hits.hits}}}),product_engine=new Bloodhound({datumTokenizer:function(hits){return Bloodhound.tokenizers.whitespace(hits.hits)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:url_products,replace:function(url,query){var jsonStr='{"query":{"query_string":{"query":"*'+query+'*","lenient":true,"fields":["name"],"default_operator":"AND"}}}';return url.replace("%QUERY",jsonStr).replace("%CID",jQuery(this).attr("id"))},filter:function(response){return response.hits.hits}}}),howto_engine=new Bloodhound({datumTokenizer:function(hits){return Bloodhound.tokenizers.whitespace(hits.hits)},queryTokenizer:Bloodhound.tokenizers.whitespace,remote:{wildcard:"%QUERY",url:url_howto,replace:function(url,query){var jsonStr='{"query":{"query_string":{"query":"*'+query+'*","lenient":true,"fields":["name"],"default_operator":"AND"}}}';return url.replace("%QUERY",jsonStr).replace("%CID",jQuery(this).attr("id"))},filter:function(response){return response.hits.hits}}});cats_engine.initialize(),product_engine.initialize(),howto_engine.initialize(),jQuery(".typeahead").typeahead({hint:!0,highlight:!0,minLength:4},{name:"products",displayKey:function(hits){return""},source:product_engine.ttAdapter(),limit:4,templates:{header:"<h5>Products</h5>",footer:'<p><a href="/search/p?q='+jQuery(".tt-input").first().val()+'&p=1">View all</a></p>',suggestion:function(data){return'<p class="quick_search"><strong>'+data._source.name+"</strong> - "+data._source.productcode+"</p>"}}},{name:"categories",displayKey:function(){return""},source:cats_engine.ttAdapter(),limit:4,templates:{header:"<h5>Categories</h5>",suggestion:function(data){return'<p class="quick_search"><strong>'+data._source.name+"</strong></p>"}}},{name:"howto",displayKey:function(){return""},source:howto_engine.ttAdapter(),limit:4,templates:{header:"<h5>How To Guides</h5>",footer:'<p><a href="/search/?q='+jQuery(".tt-input").first().val()+'&p=0">View all</a></p>',suggestion:function(data){return'<p class="quick_search"><strong>'+data._source.name+"</strong> - "+data._id+"</p>"}}}),jQuery(".typeahead").bind("typeahead:selected",function(obj,datum){switch(datum._type){case"howto":case"howtoguide":window.location.href="/h/"+datum._id;break;case"category":window.location.href="http://"+datum._url;break;case"product":default:window.location.href="/p/"+datum._source.productcode}})});